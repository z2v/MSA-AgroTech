@startuml Архитектура_АгроТех_Системы_v4

!include <C4/C4_Container.puml>

' === Участники ===
Person(директор, "Директор хозяйства", "Управление через веб-портал")
Person(агроном, "Агроном", "Использует мобильное приложение")
Person(тепличник, "Тепличный комплекс", "Управление теплицами")
Person(механик, "Механик", "Мониторинг техники")
Person(аналитик, "Аналитик", "Работа с BI-системой")

System_Boundary(платформа, "АгроПром Х - Цифровая платформа") {
    Container(веб_портал, "Веб-портал", "React", "Управление хозяйством")
    Container(мобильное_приложение, "Мобильное приложение", "Flutter", "Полевые работы")
    ContainerDb(erp, "ERP система (1С:Агро)", "1С", "Финансы, склад, кадры")

    Container_Boundary(тепличные_системы, "Тепличные комплексы") {
        Container(scada, "SCADA система", "Ignition", "Управление климатом")
        Container(тепличные_датчики, "Тепличные датчики", "Python", "Микроклимат, полив")
        Container(автополив, "Система автополива", "C++", "Управление орошением")
    }

    Container(kafka, "Брокер сообщений", "Apache Kafka", "Шина данных")

    Container_Boundary(iot_платформа, "IoT платформа") {
        Container(iot_шлюз, "IoT шлюз", "Node-RED", "Сбор данных с полей")
        Container(tsdb, "База временных рядов", "TimescaleDB", "Данные датчиков")
        Container(трекер_техники, "Трекер техники", "Java", "Мониторинг транспорта")
    }

    Container_Boundary(полевые_данные, "Данные с полей") {
        Container(метео_данные, "Метеостанции", "Python", "Погодные условия")
        Container(почва, "Датчики почвы", "Python", "Влажность, состав")
        Container(урожайность, "Мониторинг урожая", "Python", "Камера+ИИ на технике")
    }

    Container_Boundary(управление_техникой, "Управление техникой") {
        Container(планировщик, "Планировщик заданий", "Kotlin", "Распределение работ")
        Container(мониторинг_гсм, "Мониторинг ГСМ", "Go", "Контроль топлива")
        Container(диагностика, "Диагностика", "C#", "Состояние техники")
    }

    Container_Boundary(данные, "Хранилища данных") {
        ContainerDb(data_lake, "Data Lake", "MinIO", "Сырые данные (S3-совместимое)")
        ContainerDb(dwh, "Data Warehouse", "ClickHouse", "Структурированные данные")
    }

    Container(bi, "BI система", "Power BI", "Отчеты и визуализация")
    Container(аналитика, "Аналитический модуль", "Python+Spark", "Анализ эффективности")
}

' === Взаимосвязи ===
Rel(директор, веб_портал, "Использует")
Rel(агроном, мобильное_приложение, "Использует")
Rel(тепличник, scada, "Управляет")
Rel(механик, трекер_техники, "Мониторит")
Rel(аналитик, bi, "Анализирует")

' Центральная Kafka
Rel(iot_шлюз, kafka, "Публикует данные", "Kafka Protocol")
Rel(тепличные_датчики, kafka, "Публикует данные", "MQTT->Kafka")
Rel(трекер_техники, kafka, "Публикует позиции", "Kafka Protocol")
Rel(kafka, data_lake, "Сырые данные", "Kafka Connect+S3")
Rel(kafka, dwh, "Трансформированные данные", "ETL+Airflow")

' Тепличные системы
Rel(scada, kafka, "Публикует климат-данные", "OPC UA->Kafka")
Rel(автополив, scada, "Получает команды", "Modbus TCP")
Rel(тепличные_датчики, scada, "Передает данные", "LoRaWAN")

' Полевые данные
Rel(метео_данные, iot_шлюз, "Передает данные", "LoRaWAN")
Rel(почва, iot_шлюз, "Передает данные", "LoRaWAN")
Rel(урожайность, iot_шлюз, "Передает данные", "4G")

' Управление техникой
Rel(kafka, планировщик, "Поток задач", "Kafka Protocol")
Rel(мониторинг_гсм, dwh, "Сохраняет данные", "ETL")
Rel(диагностика, erp, "Передает данные о ремонтах", "REST API")

' Аналитика
Rel(data_lake, аналитика, "Доступ к сырым данным", "Spark")
Rel(dwh, аналитика, "Доступ к структурированным данным", "SQL")
Rel(аналитика, bi, "Передает отчеты", "ODBC")
Rel(аналитика, веб_портал, "Формирует рекомендации", "WebSocket")

' ERP интеграция
Rel(веб_портал, erp, "Синхронизация данных", "REST API")
Rel(erp, dwh, "Бизнес-данные", "ETL")
Rel(мобильное_приложение, kafka, "Полевые отчеты", "Kafka Protocol")

@enduml
